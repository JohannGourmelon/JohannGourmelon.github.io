<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CV Johann GOURMELON</title>
    <link rel="stylesheet" href="css/reset.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div class="container mt-5">
      <!-- Les sections du CV seront créées dynamiquement ici -->
      <div class="cv-sections"></div>
    </div>

    <!-- Utilisation des SDK Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
      // Fonction pour configurer Firebase
      function configureFirebase() {
        const firebaseConfig = {
          apiKey: "AIzaSyDXzCWirrVZFEQB_-25mzokLmrIJO0dshA",
          authDomain: "moncv-66020.firebaseapp.com",
          projectId: "moncv-66020",
          storageBucket: "moncv-66020.appspot.com",
          messagingSenderId: "307188990779",
          appId: "1:307188990779:web:391dc209f8a658007f2d1e",
          measurementId: "G-TKRK1HPSXC",
        };
        firebase.initializeApp(firebaseConfig);
        return firebase.firestore();
      }

      // Fonction pour récupérer les données du CV depuis Firestore
      async function fetchCVData(db) {
        const cvRef = db.collection("CV").doc("cv_id");
        const doc = await cvRef.get();
        if (doc.exists) {
          const competences = await cvRef.collection("competence").get();
          const experiences = await cvRef.collection("experience").get();
          const formations = await cvRef.collection("formation").get();
          const centresInteret = await cvRef.collection("centres_interet").get();
          const competencesFonctionnelles = await cvRef.collection("competence_fonctionnelle").get();

          return {
            cvData: doc.data(),
            competenceData: mapFirestoreData(competences),
            experienceData: mapFirestoreData(experiences),
            formationData: mapFirestoreData(formations),
            centresInteretData: mapFirestoreData(centresInteret),
            competenceFonctionnelleData: mapFirestoreData(competencesFonctionnelles),
          };
        } else {
          throw new Error("Aucun CV trouvé.");
        }
      }

      // Fonction utilitaire pour convertir les documents Firestore en objets
      function mapFirestoreData(collection) {
        const data = {};
        collection.forEach((doc) => (data[doc.id] = doc.data()));
        return data;
      }

      // Fonction pour créer une section HTML avec un titre et du contenu
      function createSection(title, content) {
        const section = document.createElement("section");
        const h4 = document.createElement("h4");
        h4.textContent = title;
        section.appendChild(h4);
        section.appendChild(content);
        document.querySelector(".cv-sections").appendChild(section);
      }

      // Fonction pour créer la section des informations personnelles
      function createPersonalInfoSection(cvData) {
        const div = document.createElement("div");
        div.classList.add("text-center");
        div.innerHTML = `
              <h1>${cvData.nom || "Nom non disponible"}</h1>
              <p>${cvData.adresse || "Adresse non disponible"} | ${cvData.email || "Email non disponible"} | ${cvData.telephone || "Téléphone non disponible"}</p>
              <h3>${cvData.profession || "Profession non disponible"}</h3>
          `;
        document.querySelector(".cv-sections").appendChild(div);
      }

      // Fonction pour créer les différentes sections du CV
      function createTechnicalSkillsSection(competenceData) {
        const ul = document.createElement("ul");
        Object.keys(competenceData).forEach((key) => {
          const competence = competenceData[key];
          const li = document.createElement("li");
          li.innerHTML = `<strong>${competence.intitule || "Intitulé non disponible"} :</strong>`;
          if (Array.isArray(competence.description) && typeof competence.description[0] === "object") {
            const innerUl = document.createElement("ul");
            competence.description.forEach((item) => {
              const subLi = document.createElement("li");
              const subKey = Object.keys(item)[0];
              subLi.textContent = `${subKey} : ${item[subKey]}`;
              innerUl.appendChild(subLi);
            });
            li.appendChild(innerUl);
          } else {
            li.innerHTML += ` ${competence.description || "Description non disponible"}`;
          }
          ul.appendChild(li);
        });
        createSection("Compétences Techniques", ul);
      }

      function createFunctionalSkillsSection(competenceFonctionnelleData) {
        const ul = document.createElement("ul");
        Object.keys(competenceFonctionnelleData).forEach((key) => {
          const competence = competenceFonctionnelleData[key];
          const li = document.createElement("li");
          li.innerHTML = `<strong>${competence.intitule || "Intitulé non disponible"} :</strong> ${competence.description || "Description non disponible"}`;
          ul.appendChild(li);
        });
        createSection("Compétences Fonctionnelles", ul);
      }

      function createFormationSection(formationData) {
        const ul = document.createElement("ul");
        Object.keys(formationData).forEach((key) => {
          const formation = formationData[key];
          const li = document.createElement("li");
          li.innerHTML = `${formation.dates_debut || ""} : <strong>${formation.diplome}</strong> - ${formation.etablissement}`;
          ul.appendChild(li);
        });
        createSection("Diplômes et Formations", ul);
      }

      function createExperiencesSection(experienceData) {
        const ul = document.createElement("ul");
        Object.keys(experienceData).forEach((key) => {
          const experience = experienceData[key];
          const li = document.createElement("li");
          li.innerHTML = `<strong>${experience.dates_debut || ""} – ${experience.dates_fin || ""} : ${experience.poste} – ${experience.entreprise}</strong>`;
          const innerUl = document.createElement("ul");
          experience.description.forEach((desc) => {
            const subLi = document.createElement("li");
            subLi.textContent = desc;
            innerUl.appendChild(subLi);
          });
          li.appendChild(innerUl);
          ul.appendChild(li);
        });
        createSection("Expériences", ul);
      }

      function createInterestsSection(centresInteretData) {
        const ul = document.createElement("ul");
        Object.keys(centresInteretData).forEach((key) => {
          const centre = centresInteretData[key];
          const li = document.createElement("li");
          li.textContent = `${centre.titre} : ${centre.description}`;
          ul.appendChild(li);
        });
        createSection("Centres d'intérêt", ul);
      }

      // Fonction pour initialiser l'application
      async function init() {
        try {
          const db = configureFirebase();
          const data = await fetchCVData(db);

          // Création des différentes sections du CV
          createPersonalInfoSection(data.cvData);
          createTechnicalSkillsSection(data.competenceData);
          createFunctionalSkillsSection(data.competenceFonctionnelleData);
          createFormationSection(data.formationData);
          createExperiencesSection(data.experienceData);
          createInterestsSection(data.centresInteretData);
        } catch (error) {
          console.error("Erreur lors de l'initialisation :", error);
        }
      }

      // Charger les données du CV lors du chargement de la page
      init();
    </script>
  </body>
</html>
